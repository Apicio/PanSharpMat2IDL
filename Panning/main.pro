@paths.pro
RESTORE, PATH_TO_LOAD_MS
sizes = SIZE(MS) ;[N_DIM,DIM1,DIM2,DIM3,..,N_ELEM]
PANIMAGE4 = INTARR(sizes(1),sizes(2),sizes(3)) 
PANIMAGE4(*,*,0) = IM1CROPPAN
PANIMAGE4(*,*,1) = IM1CROPPAN
PANIMAGE4(*,*,2) = IM1CROPPAN
PANIMAGE4(*,*,3) = IM1CROPPAN
N = 3
;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;       MTF      ;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;
;function MTF_Filt, toFilt, N, scale
;toFilt -> Immagine da filtrare
;N      -> Dimensione del filtro
;scale  -> Fattore di scala (3 nel caso EO-1)
MTF_PANIMAGE = INTARR(sizes(1),sizes(2),sizes(3))
MTF_Nyq = [0.5,0.5,0.5,0.5] ;; DA CAMBIARE, PRESO DA SENSORE QB. L'ordine delle bande Ã¨ B-G-R-IR ma in questo momento non ci interessa
fcut = 1./N;
NBands = sizes(3)
NFILTER=41.
;filter = [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1.74804660873557e-07,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,-7.01076945830988e-11,1.17631271309441e-10,8.31521513848061e-10,1.52768569444874e-08,1.09220663989210e-07,3.58755120750148e-07,5.32372283745025e-07,3.58755120750148e-07,1.09220663989210e-07,1.52768569444874e-08,8.31521513848061e-10,1.17631271309441e-10,-7.01076945830988e-11,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,7.44333376620322e-11,-9.41278574591829e-11,1.19663760810194e-10,-2.00777706220638e-10,-1.41926501721741e-09,-2.60748882998767e-08,-1.86419973190717e-07,-6.12329768346484e-07,-9.08662492096403e-07,-6.12329768346484e-07,-1.86419973190717e-07,-2.60748882998767e-08,-1.41926501721741e-09,-2.00777706220638e-10,1.19663760810194e-10,-9.41278574591829e-11,7.44333376620322e-11,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,-6.92723478206012e-11,8.60102255879662e-11,-1.07678974221612e-10,1.36167859579865e-10,-1.73108363956600e-10,2.90449015915532e-10,2.05312370971336e-09,3.77200723229309e-08,2.69675653220610e-07,8.85797319428598e-07,1.31447252273223e-06,8.85797319428598e-07,2.69675653220610e-07,3.77200723229309e-08,2.05312370971336e-09,2.90449015915532e-10,-1.73108363956600e-10,1.36167859579865e-10,-1.07678974221612e-10,8.60102255879662e-11,-6.92723478206012e-11,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,6.10999490191247e-11,-7.52386574009618e-11,9.28881542641619e-11,-1.15329011674555e-10,1.44385631762208e-10,-1.82582842350716e-10,2.32112520351381e-10,-3.89451389022575e-10,-2.75293210535230e-09,-5.05767963532372e-08,-3.61592842549251e-07,-1.18771487248658e-06,-1.76250067116564e-06,-1.18771487248658e-06,-3.61592842549251e-07,-5.05767963532372e-08,-2.75293210535230e-09,-3.89451389022575e-10,2.32112520351381e-10,-1.82582842350716e-10,1.44385631762208e-10,-1.15329011674555e-10,9.28881542641619e-11,-7.52386574009618e-11,6.10999490191247e-11,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,6.37723018791553e-11,-7.86371104782577e-11,9.68355150889588e-11,-1.19551770924946e-10,1.48430860434670e-10,-1.85829468915791e-10,2.34985920316306e-10,-2.98727370413178e-10,5.01225320666216e-10,3.54300722503366e-09,6.50917899170943e-08,4.65365354906021e-07,1.52857313859127e-06,2.26831461796161e-06,1.52857313859127e-06,4.65365354906021e-07,6.50917899170943e-08,3.54300722503366e-09,5.01225320666216e-10,-2.98727370413178e-10,2.34985920316306e-10,-1.85829468915791e-10,1.48430860434670e-10,-1.19551770924946e-10,9.68355150889588e-11,-7.86371104782577e-11,6.37723018791553e-11,0,0,0,0,0,0,0],[0,0,0,0,0,0,6.46133399647898e-11,-8.01779913974626e-11,9.88642840893923e-11,-1.21745662873660e-10,1.50299563775572e-10,-1.86609187864349e-10,2.33621377795483e-10,-2.95424066815120e-10,3.75554356492810e-10,-6.30136386912052e-10,-4.45420334170628e-09,-8.18318691233355e-08,-5.85045519696349e-07,-1.92168279068240e-06,-2.85166673341359e-06,-1.92168279068240e-06,-5.85045519696349e-07,-8.18318691233355e-08,-4.45420334170628e-09,-6.30136386912052e-10,3.75554356492810e-10,-2.95424066815120e-10,2.33621377795483e-10,-1.86609187864349e-10,1.50299563775572e-10,-1.21745662873660e-10,9.88642840893923e-11,-8.01779913974626e-11,6.46133399647898e-11,0,0,0,0,0,0],[0,0,0,0,0,6.37723021778143e-11,-8.01779912314521e-11,9.94880477432421e-11,-1.22676912780166e-10,1.51070577509415e-10,-1.86495292740956e-10,2.31553015858922e-10,-2.89879306453540e-10,3.66570030654744e-10,-4.65989954076711e-10,7.81884371093695e-10,5.52680288648508e-09,1.01537038607265e-07,7.25923810979965e-07,2.38442143725617e-06,3.53834453625047e-06,2.38442143725617e-06,7.25923810979965e-07,1.01537038607265e-07,5.52680288648508e-09,7.81884371093695e-10,-4.65989954076711e-10,3.66570030654744e-10,-2.89879306453540e-10,2.31553015858922e-10,-1.86495292740956e-10,1.51070577509415e-10,-1.22676912780166e-10,9.94880477432421e-11,-8.01779912314521e-11,6.37723021778143e-11,0,0,0,0,0],[0,0,0,0,6.10999486044962e-11,-7.86371098965995e-11,9.88642845991539e-11,-1.22676912318775e-10,1.51273173051940e-10,-1.86274340454197e-10,2.29958611027956e-10,-2.85521899773849e-10,3.57429921167139e-10,-4.51998907236768e-10,5.74576924918419e-10,-9.64092745236471e-10,-6.81468121040397e-09,-1.25196988843401e-07,-8.95075723283423e-07,-2.94002995537857e-06,-4.36283638477853e-06,-2.94002995537857e-06,-8.95075723283423e-07,-1.25196988843401e-07,-6.81468121040397e-09,-9.64092745236471e-10,5.74576924918419e-10,-4.51998907236768e-10,3.57429921167139e-10,-2.85521899773849e-10,2.29958611027956e-10,-1.86274340454197e-10,1.51273173051940e-10,-1.22676912318775e-10,9.88642845991539e-11,-7.86371098965995e-11,6.10999486044962e-11,0,0,0,0],[0,0,0,0,-7.52386580189648e-11,9.68355152125212e-11,-1.21745662869395e-10,1.51070577772753e-10,-1.86274340558422e-10,2.29376818166472e-10,-2.83174648629592e-10,3.51579360594447e-10,-4.40132987019919e-10,5.56585963596775e-10,-7.07517625908863e-10,1.18714046445612e-09,8.39139162790198e-09,1.54162858407775e-07,1.10216073864018e-06,3.62023687340203e-06,5.37222597329547e-06,3.62023687340203e-06,1.10216073864018e-06,1.54162858407775e-07,8.39139162790198e-09,1.18714046445612e-09,-7.07517625908863e-10,5.56585963596775e-10,-4.40132987019919e-10,3.51579360594447e-10,-2.83174648629592e-10,2.29376818166472e-10,-1.86274340558422e-10,1.51070577772753e-10,-1.21745662869395e-10,9.68355152125212e-11,-7.52386580189648e-11,0,0,0,0],[0,0,0,-6.92723481505287e-11,9.28881539692196e-11,-1.19551770670911e-10,1.50299563951812e-10,-1.86495292627283e-10,2.29958610855022e-10,-2.83174648479750e-10,3.49581283203781e-10,-4.34020528895005e-10,5.43349962537534e-10,-6.87088596912446e-10,8.73426254944479e-10,-1.46549263133552e-09,-1.03590816525856e-08,-1.90310981141180e-07,-1.36059288805786e-06,-4.46910333689096e-06,-6.63189815469773e-06,-4.46910333689096e-06,-1.36059288805786e-06,-1.90310981141180e-07,-1.03590816525856e-08,-1.46549263133552e-09,8.73426254944479e-10,-6.87088596912446e-10,5.43349962537534e-10,-4.34020528895005e-10,3.49581283203781e-10,-2.83174648479750e-10,2.29958610855022e-10,-1.86495292627283e-10,1.50299563951812e-10,-1.19551770670911e-10,9.28881539692196e-11,-6.92723481505287e-11,0,0,0],[0,0,0,8.60102257381305e-11,-1.15329011695655e-10,1.48430860089507e-10,-1.86609188292677e-10,2.31553015285914e-10,-2.85521899894098e-10,3.51579361016448e-10,-4.34020528690683e-10,5.38867417296185e-10,-6.74611960226140e-10,8.53047335563979e-10,-1.08441420842848e-09,1.81946114736948e-09,1.28613532693195e-08,2.36279034654250e-07,1.68922879569606e-06,5.54856785212983e-06,8.23376723298483e-06,5.54856785212983e-06,1.68922879569606e-06,2.36279034654250e-07,1.28613532693195e-08,1.81946114736948e-09,-1.08441420842848e-09,8.53047335563979e-10,-6.74611960226140e-10,5.38867417296185e-10,-4.34020528690683e-10,3.51579361016448e-10,-2.85521899894098e-10,2.31553015285914e-10,-1.86609188292677e-10,1.48430860089507e-10,-1.15329011695655e-10,8.60102257381305e-11,0,0,0],[0,0,7.44333380213226e-11,-1.07678973963948e-10,1.44385631789620e-10,-1.85829469105648e-10,2.33621377910210e-10,-2.89879306840370e-10,3.57429921320679e-10,-4.40132986933830e-10,5.43349962343380e-10,-6.74611960643448e-10,8.44506476481044e-10,-1.06790510947097e-09,1.35757227548002e-09,-2.27770445882648e-09,-1.61008166003718e-08,-2.95788292409538e-07,-2.11467098820865e-06,-6.94601196069205e-06,-1.03075043929341e-05,-6.94601196069205e-06,-2.11467098820865e-06,-2.95788292409538e-07,-1.61008166003718e-08,-2.27770445882648e-09,1.35757227548002e-09,-1.06790510947097e-09,8.44506476481044e-10,-6.74611960643448e-10,5.43349962343380e-10,-4.40132986933830e-10,3.57429921320679e-10,-2.89879306840370e-10,2.33621377910210e-10,-1.85829469105648e-10,1.44385631789620e-10,-1.07678973963948e-10,7.44333380213226e-11,0,0],[0,0,-9.41278566652160e-11,1.36167859998949e-10,-1.82582842247077e-10,2.34985920446939e-10,-2.95424066389523e-10,3.66570029919096e-10,-4.51998907753149e-10,5.56585963178956e-10,-6.87088596634294e-10,8.53047335783067e-10,-1.06790510919871e-09,1.35042885750327e-09,-1.71664520716558e-09,2.88022026001171e-09,2.03598613740544e-08,3.74031755265974e-07,2.67404144082536e-06,8.78337032635397e-06,1.30340573310127e-05,8.78337032635397e-06,2.67404144082536e-06,3.74031755265974e-07,2.03598613740544e-08,2.88022026001171e-09,-1.71664520716558e-09,1.35042885750327e-09,-1.06790510919871e-09,8.53047335783067e-10,-6.87088596634294e-10,5.56585963178956e-10,-4.51998907753149e-10,3.66570029919096e-10,-2.95424066389523e-10,2.34985920446939e-10,-1.82582842247077e-10,1.36167859998949e-10,-9.41278566652160e-11,0,0],[0,-7.01076935971519e-11,1.19663760788517e-10,-1.73108364582984e-10,2.32112519757840e-10,-2.98727371141249e-10,3.75554356392052e-10,-4.65989953979577e-10,5.74576925218514e-10,-7.07517625989448e-10,8.73426255147239e-10,-1.08441420858871e-09,1.35757227551188e-09,-1.71664520698258e-09,2.18217044019353e-09,-3.66137209749029e-09,-2.58809202729987e-08,-4.75468730289741e-07,-3.39921146803349e-06,-1.11653300603940e-05,-1.65687821930296e-05,-1.11653300603940e-05,-3.39921146803349e-06,-4.75468730289741e-07,-2.58809202729987e-08,-3.66137209749029e-09,2.18217044019353e-09,-1.71664520698258e-09,1.35757227551188e-09,-1.08441420858871e-09,8.73426255147239e-10,-7.07517625989448e-10,5.74576925218514e-10,-4.65989953979577e-10,3.75554356392052e-10,-2.98727371141249e-10,2.32112519757840e-10,-1.73108364582984e-10,1.19663760788517e-10,-7.01076935971519e-11,0],[0,1.17631271605331e-10,-2.00777706011784e-10,2.90449016200573e-10,-3.89451388513831e-10,5.01225320292473e-10,-6.30136387124891e-10,7.81884371580557e-10,-9.64092744705846e-10,1.18714046495346e-09,-1.46549263056167e-09,1.81946114789337e-09,-2.27770445880218e-09,2.88022026002375e-09,-3.66137209805616e-09,6.14324667555283e-09,4.34232860307722e-08,7.97762756920454e-07,5.70327360991262e-06,1.87334479990198e-05,2.77995372336890e-05,1.87334479990198e-05,5.70327360991262e-06,7.97762756920454e-07,4.34232860307722e-08,6.14324667555283e-09,-3.66137209805616e-09,2.88022026002375e-09,-2.27770445880218e-09,1.81946114789337e-09,-1.46549263056167e-09,1.18714046495346e-09,-9.64092744705846e-10,7.81884371580557e-10,-6.30136387124891e-10,5.01225320292473e-10,-3.89451388513831e-10,2.90449016200573e-10,-2.00777706011784e-10,1.17631271605331e-10,0],[0,8.31521513555206e-10,-1.41926501731854e-09,2.05312370986683e-09,-2.75293210487731e-09,3.54300722503281e-09,-4.45420334145180e-09,5.52680288691606e-09,-6.81468121063202e-09,8.39139162706593e-09,-1.03590816534538e-08,1.28613532680609e-08,-1.61008166022921e-08,2.03598613728633e-08,-2.58809202744413e-08,4.34232860300737e-08,3.06944217860617e-07,5.63921255967598e-06,4.03142549078158e-05,0.000132419398344821,0.000196504567573143,0.000132419398344821,4.03142549078158e-05,5.63921255967598e-06,3.06944217860617e-07,4.34232860300737e-08,-2.58809202744413e-08,2.03598613728633e-08,-1.61008166022921e-08,1.28613532680609e-08,-1.03590816534538e-08,8.39139162706593e-09,-6.81468121063202e-09,5.52680288691606e-09,-4.45420334145180e-09,3.54300722503281e-09,-2.75293210487731e-09,2.05312370986683e-09,-1.41926501731854e-09,8.31521513555206e-10,0],[0,1.52768569443777e-08,-2.60748883002462e-08,3.77200723227468e-08,-5.05767963533098e-08,6.50917899162430e-08,-8.18318691247370e-08,1.01537038605880e-07,-1.25196988844555e-07,1.54162858407125e-07,-1.90310981140318e-07,2.36279034655423e-07,-2.95788292408548e-07,3.74031755266876e-07,-4.75468730290269e-07,7.97762756919047e-07,5.63921255967489e-06,0.000103597757809794,0.000740633072204783,0.00243272745000673,0.00361007567850859,0.00243272745000673,0.000740633072204783,0.000103597757809794,5.63921255967489e-06,7.97762756919047e-07,-4.75468730290269e-07,3.74031755266876e-07,-2.95788292408548e-07,2.36279034655423e-07,-1.90310981140318e-07,1.54162858407125e-07,-1.25196988844555e-07,1.01537038605880e-07,-8.18318691247370e-08,6.50917899162430e-08,-5.05767963533098e-08,3.77200723227468e-08,-2.60748883002462e-08,1.52768569443777e-08,0],[0,1.09220663991874e-07,-1.86419973188635e-07,2.69675653222513e-07,-3.61592842548233e-07,4.65365354906497e-07,-5.85045519694900e-07,7.25923810983149e-07,-8.95075723281151e-07,1.10216073863964e-06,-1.36059288805869e-06,1.68922879569588e-06,-2.11467098820764e-06,2.67404144082775e-06,-3.39921146803175e-06,5.70327360991402e-06,4.03142549078153e-05,0.000740633072204782,0.00529499693241113,0.0173918873110020,0.0258090764741535,0.0173918873110020,0.00529499693241113,0.000740633072204782,4.03142549078153e-05,5.70327360991402e-06,-3.39921146803175e-06,2.67404144082775e-06,-2.11467098820764e-06,1.68922879569588e-06,-1.36059288805869e-06,1.10216073863964e-06,-8.95075723281151e-07,7.25923810983149e-07,-5.85045519694900e-07,4.65365354906497e-07,-3.61592842548233e-07,2.69675653222513e-07,-1.86419973188635e-07,1.09220663991874e-07,0],[0,3.58755120744392e-07,-6.12329768353166e-07,8.85797319423903e-07,-1.18771487248767e-06,1.52857313858944e-06,-1.92168279068701e-06,2.38442143725067e-06,-2.94002995537952e-06,3.62023687340662e-06,-4.46910333688423e-06,5.54856785213615e-06,-6.94601196069073e-06,8.78337032635123e-06,-1.11653300603985e-05,1.87334479990120e-05,0.000132419398344822,0.00243272745000673,0.0173918873110020,0.0571249818519869,0.0847726807286471,0.0571249818519869,0.0173918873110020,0.00243272745000673,0.000132419398344822,1.87334479990120e-05,-1.11653300603985e-05,8.78337032635123e-06,-6.94601196069073e-06,5.54856785213615e-06,-4.46910333688423e-06,3.62023687340662e-06,-2.94002995537952e-06,2.38442143725067e-06,-1.92168279068701e-06,1.52857313858944e-06,-1.18771487248767e-06,8.85797319423903e-07,-6.12329768353166e-07,3.58755120744392e-07,0],[-1.74804660870256e-07,5.32372283744341e-07,-9.08662492100489e-07,1.31447252272670e-06,-1.76250067116588e-06,2.26831461797105e-06,-2.85166673340242e-06,3.53834453625039e-06,-4.36283638478465e-06,5.37222597328842e-06,-6.63189815470353e-06,8.23376723297717e-06,-1.03075043929401e-05,1.30340573310081e-05,-1.65687821930312e-05,2.77995372336935e-05,0.000196504567573142,0.00361007567850860,0.0258090764741535,0.0847726807286471,0.125796855559942,0.0847726807286471,0.0258090764741535,0.00361007567850860,0.000196504567573142,2.77995372336935e-05,-1.65687821930312e-05,1.30340573310081e-05,-1.03075043929401e-05,8.23376723297717e-06,-6.63189815470353e-06,5.37222597328842e-06,-4.36283638478465e-06,3.53834453625039e-06,-2.85166673340242e-06,2.26831461797105e-06,-1.76250067116588e-06,1.31447252272670e-06,-9.08662492100489e-07,5.32372283744341e-07,-1.74804660870256e-07],[0,3.58755120744392e-07,-6.12329768353166e-07,8.85797319423903e-07,-1.18771487248767e-06,1.52857313858944e-06,-1.92168279068701e-06,2.38442143725067e-06,-2.94002995537952e-06,3.62023687340662e-06,-4.46910333688423e-06,5.54856785213615e-06,-6.94601196069073e-06,8.78337032635123e-06,-1.11653300603985e-05,1.87334479990120e-05,0.000132419398344822,0.00243272745000673,0.0173918873110020,0.0571249818519869,0.0847726807286471,0.0571249818519869,0.0173918873110020,0.00243272745000673,0.000132419398344822,1.87334479990120e-05,-1.11653300603985e-05,8.78337032635123e-06,-6.94601196069073e-06,5.54856785213615e-06,-4.46910333688423e-06,3.62023687340662e-06,-2.94002995537952e-06,2.38442143725067e-06,-1.92168279068701e-06,1.52857313858944e-06,-1.18771487248767e-06,8.85797319423903e-07,-6.12329768353166e-07,3.58755120744392e-07,0],[0,1.09220663991874e-07,-1.86419973188635e-07,2.69675653222513e-07,-3.61592842548233e-07,4.65365354906497e-07,-5.85045519694900e-07,7.25923810983149e-07,-8.95075723281151e-07,1.10216073863964e-06,-1.36059288805869e-06,1.68922879569588e-06,-2.11467098820764e-06,2.67404144082775e-06,-3.39921146803175e-06,5.70327360991402e-06,4.03142549078153e-05,0.000740633072204782,0.00529499693241113,0.0173918873110020,0.0258090764741535,0.0173918873110020,0.00529499693241113,0.000740633072204782,4.03142549078153e-05,5.70327360991402e-06,-3.39921146803175e-06,2.67404144082775e-06,-2.11467098820764e-06,1.68922879569588e-06,-1.36059288805869e-06,1.10216073863964e-06,-8.95075723281151e-07,7.25923810983149e-07,-5.85045519694900e-07,4.65365354906497e-07,-3.61592842548233e-07,2.69675653222513e-07,-1.86419973188635e-07,1.09220663991874e-07,0],[0,1.52768569443777e-08,-2.60748883002462e-08,3.77200723227468e-08,-5.05767963533098e-08,6.50917899162430e-08,-8.18318691247370e-08,1.01537038605880e-07,-1.25196988844555e-07,1.54162858407125e-07,-1.90310981140318e-07,2.36279034655423e-07,-2.95788292408548e-07,3.74031755266876e-07,-4.75468730290269e-07,7.97762756919047e-07,5.63921255967489e-06,0.000103597757809794,0.000740633072204783,0.00243272745000673,0.00361007567850859,0.00243272745000673,0.000740633072204783,0.000103597757809794,5.63921255967489e-06,7.97762756919047e-07,-4.75468730290269e-07,3.74031755266876e-07,-2.95788292408548e-07,2.36279034655423e-07,-1.90310981140318e-07,1.54162858407125e-07,-1.25196988844555e-07,1.01537038605880e-07,-8.18318691247370e-08,6.50917899162430e-08,-5.05767963533098e-08,3.77200723227468e-08,-2.60748883002462e-08,1.52768569443777e-08,0],[0,8.31521513555206e-10,-1.41926501731854e-09,2.05312370986683e-09,-2.75293210487731e-09,3.54300722503281e-09,-4.45420334145180e-09,5.52680288691606e-09,-6.81468121063202e-09,8.39139162706593e-09,-1.03590816534538e-08,1.28613532680609e-08,-1.61008166022921e-08,2.03598613728633e-08,-2.58809202744413e-08,4.34232860300737e-08,3.06944217860617e-07,5.63921255967598e-06,4.03142549078158e-05,0.000132419398344821,0.000196504567573143,0.000132419398344821,4.03142549078158e-05,5.63921255967598e-06,3.06944217860617e-07,4.34232860300737e-08,-2.58809202744413e-08,2.03598613728633e-08,-1.61008166022921e-08,1.28613532680609e-08,-1.03590816534538e-08,8.39139162706593e-09,-6.81468121063202e-09,5.52680288691606e-09,-4.45420334145180e-09,3.54300722503281e-09,-2.75293210487731e-09,2.05312370986683e-09,-1.41926501731854e-09,8.31521513555206e-10,0],[0,1.17631271605331e-10,-2.00777706011784e-10,2.90449016200573e-10,-3.89451388513831e-10,5.01225320292473e-10,-6.30136387124891e-10,7.81884371580557e-10,-9.64092744705846e-10,1.18714046495346e-09,-1.46549263056167e-09,1.81946114789337e-09,-2.27770445880218e-09,2.88022026002375e-09,-3.66137209805616e-09,6.14324667555283e-09,4.34232860307722e-08,7.97762756920454e-07,5.70327360991262e-06,1.87334479990198e-05,2.77995372336890e-05,1.87334479990198e-05,5.70327360991262e-06,7.97762756920454e-07,4.34232860307722e-08,6.14324667555283e-09,-3.66137209805616e-09,2.88022026002375e-09,-2.27770445880218e-09,1.81946114789337e-09,-1.46549263056167e-09,1.18714046495346e-09,-9.64092744705846e-10,7.81884371580557e-10,-6.30136387124891e-10,5.01225320292473e-10,-3.89451388513831e-10,2.90449016200573e-10,-2.00777706011784e-10,1.17631271605331e-10,0],[0,-7.01076935971519e-11,1.19663760788517e-10,-1.73108364582984e-10,2.32112519757840e-10,-2.98727371141249e-10,3.75554356392052e-10,-4.65989953979577e-10,5.74576925218514e-10,-7.07517625989448e-10,8.73426255147239e-10,-1.08441420858871e-09,1.35757227551188e-09,-1.71664520698258e-09,2.18217044019353e-09,-3.66137209749029e-09,-2.58809202729987e-08,-4.75468730289741e-07,-3.39921146803349e-06,-1.11653300603940e-05,-1.65687821930296e-05,-1.11653300603940e-05,-3.39921146803349e-06,-4.75468730289741e-07,-2.58809202729987e-08,-3.66137209749029e-09,2.18217044019353e-09,-1.71664520698258e-09,1.35757227551188e-09,-1.08441420858871e-09,8.73426255147239e-10,-7.07517625989448e-10,5.74576925218514e-10,-4.65989953979577e-10,3.75554356392052e-10,-2.98727371141249e-10,2.32112519757840e-10,-1.73108364582984e-10,1.19663760788517e-10,-7.01076935971519e-11,0],[0,0,-9.41278566652160e-11,1.36167859998949e-10,-1.82582842247077e-10,2.34985920446939e-10,-2.95424066389523e-10,3.66570029919096e-10,-4.51998907753149e-10,5.56585963178956e-10,-6.87088596634294e-10,8.53047335783067e-10,-1.06790510919871e-09,1.35042885750327e-09,-1.71664520716558e-09,2.88022026001171e-09,2.03598613740544e-08,3.74031755265974e-07,2.67404144082536e-06,8.78337032635397e-06,1.30340573310127e-05,8.78337032635397e-06,2.67404144082536e-06,3.74031755265974e-07,2.03598613740544e-08,2.88022026001171e-09,-1.71664520716558e-09,1.35042885750327e-09,-1.06790510919871e-09,8.53047335783067e-10,-6.87088596634294e-10,5.56585963178956e-10,-4.51998907753149e-10,3.66570029919096e-10,-2.95424066389523e-10,2.34985920446939e-10,-1.82582842247077e-10,1.36167859998949e-10,-9.41278566652160e-11,0,0],[0,0,7.44333380213226e-11,-1.07678973963948e-10,1.44385631789620e-10,-1.85829469105648e-10,2.33621377910210e-10,-2.89879306840370e-10,3.57429921320679e-10,-4.40132986933830e-10,5.43349962343380e-10,-6.74611960643448e-10,8.44506476481044e-10,-1.06790510947097e-09,1.35757227548002e-09,-2.27770445882648e-09,-1.61008166003718e-08,-2.95788292409538e-07,-2.11467098820865e-06,-6.94601196069205e-06,-1.03075043929341e-05,-6.94601196069205e-06,-2.11467098820865e-06,-2.95788292409538e-07,-1.61008166003718e-08,-2.27770445882648e-09,1.35757227548002e-09,-1.06790510947097e-09,8.44506476481044e-10,-6.74611960643448e-10,5.43349962343380e-10,-4.40132986933830e-10,3.57429921320679e-10,-2.89879306840370e-10,2.33621377910210e-10,-1.85829469105648e-10,1.44385631789620e-10,-1.07678973963948e-10,7.44333380213226e-11,0,0],[0,0,0,8.60102257381305e-11,-1.15329011695655e-10,1.48430860089507e-10,-1.86609188292677e-10,2.31553015285914e-10,-2.85521899894098e-10,3.51579361016448e-10,-4.34020528690683e-10,5.38867417296185e-10,-6.74611960226140e-10,8.53047335563979e-10,-1.08441420842848e-09,1.81946114736948e-09,1.28613532693195e-08,2.36279034654250e-07,1.68922879569606e-06,5.54856785212983e-06,8.23376723298483e-06,5.54856785212983e-06,1.68922879569606e-06,2.36279034654250e-07,1.28613532693195e-08,1.81946114736948e-09,-1.08441420842848e-09,8.53047335563979e-10,-6.74611960226140e-10,5.38867417296185e-10,-4.34020528690683e-10,3.51579361016448e-10,-2.85521899894098e-10,2.31553015285914e-10,-1.86609188292677e-10,1.48430860089507e-10,-1.15329011695655e-10,8.60102257381305e-11,0,0,0],[0,0,0,-6.92723481505287e-11,9.28881539692196e-11,-1.19551770670911e-10,1.50299563951812e-10,-1.86495292627283e-10,2.29958610855022e-10,-2.83174648479750e-10,3.49581283203781e-10,-4.34020528895005e-10,5.43349962537534e-10,-6.87088596912446e-10,8.73426254944479e-10,-1.46549263133552e-09,-1.03590816525856e-08,-1.90310981141180e-07,-1.36059288805786e-06,-4.46910333689096e-06,-6.63189815469773e-06,-4.46910333689096e-06,-1.36059288805786e-06,-1.90310981141180e-07,-1.03590816525856e-08,-1.46549263133552e-09,8.73426254944479e-10,-6.87088596912446e-10,5.43349962537534e-10,-4.34020528895005e-10,3.49581283203781e-10,-2.83174648479750e-10,2.29958610855022e-10,-1.86495292627283e-10,1.50299563951812e-10,-1.19551770670911e-10,9.28881539692196e-11,-6.92723481505287e-11,0,0,0],[0,0,0,0,-7.52386580189648e-11,9.68355152125212e-11,-1.21745662869395e-10,1.51070577772753e-10,-1.86274340558422e-10,2.29376818166472e-10,-2.83174648629592e-10,3.51579360594447e-10,-4.40132987019919e-10,5.56585963596775e-10,-7.07517625908863e-10,1.18714046445612e-09,8.39139162790198e-09,1.54162858407775e-07,1.10216073864018e-06,3.62023687340203e-06,5.37222597329547e-06,3.62023687340203e-06,1.10216073864018e-06,1.54162858407775e-07,8.39139162790198e-09,1.18714046445612e-09,-7.07517625908863e-10,5.56585963596775e-10,-4.40132987019919e-10,3.51579360594447e-10,-2.83174648629592e-10,2.29376818166472e-10,-1.86274340558422e-10,1.51070577772753e-10,-1.21745662869395e-10,9.68355152125212e-11,-7.52386580189648e-11,0,0,0,0],[0,0,0,0,6.10999486044962e-11,-7.86371098965995e-11,9.88642845991539e-11,-1.22676912318775e-10,1.51273173051940e-10,-1.86274340454197e-10,2.29958611027956e-10,-2.85521899773849e-10,3.57429921167139e-10,-4.51998907236768e-10,5.74576924918419e-10,-9.64092745236471e-10,-6.81468121040397e-09,-1.25196988843401e-07,-8.95075723283423e-07,-2.94002995537857e-06,-4.36283638477853e-06,-2.94002995537857e-06,-8.95075723283423e-07,-1.25196988843401e-07,-6.81468121040397e-09,-9.64092745236471e-10,5.74576924918419e-10,-4.51998907236768e-10,3.57429921167139e-10,-2.85521899773849e-10,2.29958611027956e-10,-1.86274340454197e-10,1.51273173051940e-10,-1.22676912318775e-10,9.88642845991539e-11,-7.86371098965995e-11,6.10999486044962e-11,0,0,0,0],[0,0,0,0,0,6.37723021778143e-11,-8.01779912314521e-11,9.94880477432421e-11,-1.22676912780166e-10,1.51070577509415e-10,-1.86495292740956e-10,2.31553015858922e-10,-2.89879306453540e-10,3.66570030654744e-10,-4.65989954076711e-10,7.81884371093695e-10,5.52680288648508e-09,1.01537038607265e-07,7.25923810979965e-07,2.38442143725617e-06,3.53834453625047e-06,2.38442143725617e-06,7.25923810979965e-07,1.01537038607265e-07,5.52680288648508e-09,7.81884371093695e-10,-4.65989954076711e-10,3.66570030654744e-10,-2.89879306453540e-10,2.31553015858922e-10,-1.86495292740956e-10,1.51070577509415e-10,-1.22676912780166e-10,9.94880477432421e-11,-8.01779912314521e-11,6.37723021778143e-11,0,0,0,0,0],[0,0,0,0,0,0,6.46133399647898e-11,-8.01779913974626e-11,9.88642840893923e-11,-1.21745662873660e-10,1.50299563775572e-10,-1.86609187864349e-10,2.33621377795483e-10,-2.95424066815120e-10,3.75554356492810e-10,-6.30136386912052e-10,-4.45420334170628e-09,-8.18318691233355e-08,-5.85045519696349e-07,-1.92168279068240e-06,-2.85166673341359e-06,-1.92168279068240e-06,-5.85045519696349e-07,-8.18318691233355e-08,-4.45420334170628e-09,-6.30136386912052e-10,3.75554356492810e-10,-2.95424066815120e-10,2.33621377795483e-10,-1.86609187864349e-10,1.50299563775572e-10,-1.21745662873660e-10,9.88642840893923e-11,-8.01779913974626e-11,6.46133399647898e-11,0,0,0,0,0,0],[0,0,0,0,0,0,0,6.37723018791553e-11,-7.86371104782577e-11,9.68355150889588e-11,-1.19551770924946e-10,1.48430860434670e-10,-1.85829468915791e-10,2.34985920316306e-10,-2.98727370413178e-10,5.01225320666216e-10,3.54300722503366e-09,6.50917899170943e-08,4.65365354906021e-07,1.52857313859127e-06,2.26831461796161e-06,1.52857313859127e-06,4.65365354906021e-07,6.50917899170943e-08,3.54300722503366e-09,5.01225320666216e-10,-2.98727370413178e-10,2.34985920316306e-10,-1.85829468915791e-10,1.48430860434670e-10,-1.19551770924946e-10,9.68355150889588e-11,-7.86371104782577e-11,6.37723018791553e-11,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,6.10999490191247e-11,-7.52386574009618e-11,9.28881542641619e-11,-1.15329011674555e-10,1.44385631762208e-10,-1.82582842350716e-10,2.32112520351381e-10,-3.89451389022575e-10,-2.75293210535230e-09,-5.05767963532372e-08,-3.61592842549251e-07,-1.18771487248658e-06,-1.76250067116564e-06,-1.18771487248658e-06,-3.61592842549251e-07,-5.05767963532372e-08,-2.75293210535230e-09,-3.89451389022575e-10,2.32112520351381e-10,-1.82582842350716e-10,1.44385631762208e-10,-1.15329011674555e-10,9.28881542641619e-11,-7.52386574009618e-11,6.10999490191247e-11,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,-6.92723478206012e-11,8.60102255879662e-11,-1.07678974221612e-10,1.36167859579865e-10,-1.73108363956600e-10,2.90449015915532e-10,2.05312370971336e-09,3.77200723229309e-08,2.69675653220610e-07,8.85797319428598e-07,1.31447252273223e-06,8.85797319428598e-07,2.69675653220610e-07,3.77200723229309e-08,2.05312370971336e-09,2.90449015915532e-10,-1.73108363956600e-10,1.36167859579865e-10,-1.07678974221612e-10,8.60102255879662e-11,-6.92723478206012e-11,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,7.44333376620322e-11,-9.41278574591829e-11,1.19663760810194e-10,-2.00777706220638e-10,-1.41926501721741e-09,-2.60748882998767e-08,-1.86419973190717e-07,-6.12329768346484e-07,-9.08662492096403e-07,-6.12329768346484e-07,-1.86419973190717e-07,-2.60748882998767e-08,-1.41926501721741e-09,-2.00777706220638e-10,1.19663760810194e-10,-9.41278574591829e-11,7.44333376620322e-11,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,-7.01076945830988e-11,1.17631271309441e-10,8.31521513848061e-10,1.52768569444874e-08,1.09220663989210e-07,3.58755120750148e-07,5.32372283745025e-07,3.58755120750148e-07,1.09220663989210e-07,1.52768569444874e-08,8.31521513848061e-10,1.17631271309441e-10,-7.01076945830988e-11,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1.74804660873557e-07,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]
FOR i=0,NBands-1 DO BEGIN
  sigma = SQRT( ((NFILTER*(fcut/2.))^2) / (-2.*alog(MTF_Nyq(i))) ) 
  filter = GAUSSIAN_FUNCTION([sigma,sigma], WIDTH = NFILTER)
  filter = filter/total(filter)
  filter = filter/max(filter)
  filter = CONVOL(filter,hanning(NFILTER),  /EDGE_TRUNCATE)
  MTF_PANIMAGE(*,*,i) = CONVOL(FLOAT(PANIMAGE4(*,*,i)),filter, /EDGE_TRUNCATE)
ENDFOR
MTF_PANIMAGE = PANIMAGE4
;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; Blurring PAN Image ;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;
PANIMAGERIC = INTARR(sizes(1),sizes(2), sizes(3))
PANIMAGERIC(*,*,0) = fresize(MTF_PANIMAGE(*,*,0), N)
PANIMAGERIC(*,*,1) = fresize(MTF_PANIMAGE(*,*,1), N)
PANIMAGERIC(*,*,2) = fresize(MTF_PANIMAGE(*,*,2), N)
PANIMAGERIC(*,*,3) = fresize(MTF_PANIMAGE(*,*,3), N)
;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; Histogram Matching ;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;
M1_HIST =  histogram(MS(*,*,0), NBINS=256)
M2_HIST =  histogram(MS(*,*,1), NBINS=256)
M3_HIST =  histogram(MS(*,*,2), NBINS=256)
M4_HIST =  histogram(MS(*,*,3), NBINS=256)
PANIMAGERIC_H = INTARR(sizes(1),sizes(2), sizes(3))

PANIMAGERIC_H(*,*,0) = histomatch(PANIMAGERIC(*,*,0), M1_HIST)
PANIMAGERIC_H(*,*,1) = histomatch(PANIMAGERIC(*,*,1), M2_HIST)
PANIMAGERIC_H(*,*,2) = histomatch(PANIMAGERIC(*,*,2), M3_HIST)
PANIMAGERIC_H(*,*,3) = histomatch(PANIMAGERIC(*,*,3), M4_HIST)
PANIMAGERIC_H = PANIMAGERIC
;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;; Compute Gains Gk ;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;
var_pl1 = variance(PANIMAGERIC_H(*,*,0))
var_pl2 = variance(PANIMAGERIC_H(*,*,1))
var_pl3 = variance(PANIMAGERIC_H(*,*,2))
var_pl4 = variance(PANIMAGERIC_H(*,*,3))

mean_pl1 = mean(PANIMAGERIC_H(*,*,0))
mean_pl2 = mean(PANIMAGERIC_H(*,*,1))
mean_pl3 = mean(PANIMAGERIC_H(*,*,2))
mean_pl4 = mean(PANIMAGERIC_H(*,*,3))

mean_ms1 = mean(MS(*,*,0))
mean_ms2 = mean(MS(*,*,1))
mean_ms3 = mean(MS(*,*,2))
mean_ms4 = mean(MS(*,*,3))

ms1pl_cov = mean((MS(*,*,0) - mean_ms1)*(PANIMAGERIC_H(*,*,0) - mean_pl1)) ;
ms2pl_cov = mean((MS(*,*,1) - mean_ms2)*(PANIMAGERIC_H(*,*,1) - mean_pl2)) ;
ms3pl_cov = mean((MS(*,*,2) - mean_ms3)*(PANIMAGERIC_H(*,*,2) - mean_pl3)) ;
ms4pl_cov = mean((MS(*,*,3) - mean_ms4)*(PANIMAGERIC_H(*,*,3) - mean_pl4)) ;

G1 = ms1pl_cov/var_pl1
G2 = ms2pl_cov/var_pl2
G3 = ms3pl_cov/var_pl3
G4 = ms4pl_cov/var_pl4
;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;       Fuse     ;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;
DELTA_PAN = PANIMAGE4 - PANIMAGERIC_H

GAIN_PAN = INTARR(sizes(1),sizes(2), sizes(3))
GAIN_PAN(*, *,0) = G1*DELTA_PAN(*,*,0)
GAIN_PAN(*, *,1) = G2*DELTA_PAN(*,*,1)
GAIN_PAN(*, *,2) = G3*DELTA_PAN(*,*,2)
GAIN_PAN(*, *,3) = G4*DELTA_PAN(*,*,3)

FUSED_MS = GAIN_PAN + MS

im = image(FUSED_MS[*,*,0:2])
im = image(IM1CROPPAN)
im = image(MS[*,*,0:2])
end